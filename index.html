<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <!-- user-scalable=no zapobiega powiększaniu interfejsu strony, pozwalając na zoom tylko w 3D -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Interaktywny Model Układu Słoneczny 3D</title>
    <!-- Ładowanie Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ładowanie Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Ładowanie OrbitControls dla nawigacji kamerą -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        /* Styl dla całego ciała strony */
        body {
            margin: 0;
            overflow: hidden; /* Ukrywamy paski przewijania */
            font-family: 'Inter', sans-serif;
            color: #ffffff;
            background-color: #0d1117;
            touch-action: none; /* Wyłącza domyślne gesty przeglądarki na rzecz Three.js */
        }
        /* Styl dla kontenera wizualizacji 3D */
        #container {
            width: 100vw;
            height: 100vh;
        }
        /* Styl dla wyświetlania nazw planet */
        .planet-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            transform: translate(-50%, -50%);
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            user-select: none;
            -webkit-user-select: none;
        }
        /* Styl dla obrazu w modalu */
        .modal-img {
            width: 100%;
            max-height: 160px;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gray-900">

    <div id="container"></div>

    <!-- Panel instrukcji z przyciskiem zamknięcia -->
    <div id="info-panel" class="absolute top-4 left-4 p-4 bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-xl max-w-xs text-sm z-20 transition-opacity duration-300 border border-gray-700">
        <div class="flex justify-between items-start mb-2">
            <h2 class="text-lg font-bold text-yellow-300">Układ Słoneczny 3D</h2>
            <!-- Przycisk zamknięcia -->
            <button onclick="document.getElementById('info-panel').style.display='none'" class="text-gray-400 hover:text-white p-1 -mt-1 -mr-1 focus:outline-none transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Instrukcje dla Desktopu (domyślnie ukryte) -->
        <div id="desktop-instructions" class="hidden text-gray-300 space-y-1">
            <p><strong class="text-white">Lewy przycisk:</strong> Obracanie widoku</p>
            <p><strong class="text-white">Prawy przycisk:</strong> Przesuwanie (Pan)</p>
            <p><strong class="text-white">Kółko myszy:</strong> Przybliżanie (Zoom)</p>
            <p><strong class="text-yellow-300">Kliknięcie:</strong> Informacje o planecie</p>
        </div>

        <!-- Instrukcje dla Mobile (domyślnie ukryte) -->
        <div id="mobile-instructions" class="hidden text-gray-300 space-y-1">
            <p><strong class="text-white">Jeden palec:</strong> Obracanie widoku</p>
            <p><strong class="text-white">Dwa palce:</strong> Zoom (szczypanie) / Przesuwanie</p>
            <p><strong class="text-yellow-300">Tapnięcie:</strong> Informacje o planecie</p>
        </div>
        
        <div class="mt-3 pt-2 border-t border-gray-700 text-xs text-gray-500 italic text-center">
            Zamknij to okno, aby widzieć więcej.
        </div>
    </div>

    <!-- Panel kontroli prędkości - układ kontrolowany przez JS w zależności od orientacji/rozmiaru -->
    <div id="controls-panel" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 p-2 bg-gray-800/90 backdrop-blur-md rounded-xl shadow-2xl flex z-10 w-max max-w-[90vw] transition-all duration-300">
        
        <button id="set-current-date" onclick="setPlanetsToCurrentPositions()" 
                class="px-3 py-2 md:px-4 md:py-1 bg-purple-600 hover:bg-purple-500 text-white font-semibold rounded-lg shadow-md transition duration-150 text-xs md:text-sm whitespace-nowrap">
            Aktualna data
        </button>

        <!-- Sekcja przycisków prędkości jest zawsze w poziomie, ale jest elementem flex wewnątrz panelu -->
        <div class="flex space-x-2 justify-center">
            <button id="speed-x1" onclick="setSpeedMultiplier(1)" class="flex-1 px-3 py-2 md:px-4 md:py-1 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-lg shadow-md transition duration-150 text-xs md:text-sm">10min/sek</button>
            <button id="speed-x10" onclick="setSpeedMultiplier(10)" class="flex-1 px-3 py-2 md:px-4 md:py-1 bg-gray-600 hover:bg-blue-500 text-white font-semibold rounded-lg shadow-md transition duration-150 text-xs md:text-sm">90min/sek</button>
            <button id="speed-x100" onclick="setSpeedMultiplier(100)" class="flex-1 px-3 py-2 md:px-4 md:py-1 bg-gray-600 hover:bg-blue-500 text-white font-semibold rounded-lg shadow-md transition duration-150 text-xs md:text-sm">12h/sek</button>
        </div>
    </div>

    <!-- Wskaźnik daty -->
    <div id="date-time-panel" class="absolute top-4 right-4 p-2 bg-gray-800/80 backdrop-blur-sm rounded-lg shadow-xl text-xs md:text-sm font-mono z-10 pointer-events-none">
        <span id="current-date-time" class="text-yellow-400">Ładowanie...</span>
    </div>

    <!-- MODAL INFORMACYJNY -->
    <div id="planet-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-yellow-500/50 transform transition-all scale-100">
            
            <div id="modal-image-container" class="mb-4 rounded-lg overflow-hidden flex justify-center border border-gray-700 bg-black/50">
                <!-- Obraz -->
            </div>
            
            <h3 id="modal-planet-name" class="text-2xl font-bold text-yellow-300 mb-4 text-center"></h3>
            
            <div id="modal-planet-details" class="text-gray-200 space-y-2 text-sm">
                <!-- Szczegóły -->
            </div>
            <button onclick="closeModal()"
                    class="mt-6 w-full py-3 px-4 bg-yellow-600 hover:bg-yellow-500 text-gray-900 font-bold rounded-lg transition duration-150 shadow-lg active:scale-95">
                Zamknij
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfiguracja Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;

        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase init error:", error);
            }
        }
        
        if (typeof THREE !== 'undefined') initFirebase();

        // --- ZMIENNE GLOBALNE ---
        const container = document.getElementById('container');
        let scene, camera, renderer, controls, raycaster, mouse;
        const planets = []; 

        let speedMultiplier = 1;
        // Zmniejszyłem timeScale, aby symulacja była bardziej płynna po dodaniu aktualizacji czasu/godziny
        const timeScale = 0.00005; 
        const earthRotationSpeedPerFrame = 0.01; 
        let simulationDays = 0; 
        const EPOCH_DATE = new Date('2025-01-01T00:00:00Z');
        const textureLoader = new THREE.TextureLoader();
        const AU_TO_KM_MILLIONS = 149.6;

        function toMlnKm(au) { return (au * AU_TO_KM_MILLIONS).toFixed(1); }

        // --- DANE PLANET ---
        const planetData = [
            { 
                name: "Merkury", size: 1, distance: 20, orbitPeriod: 88, dayLength: 58.6, epochOffsetAngle: 2.5, 
                color: 0x777777,
                mapUrl: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets@master/images/mercurymap.jpg', 
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/4/4a/Mercury_in_true_color.jpg', 
                details: { 
                    Typ: "Planeta skalista", 
                    Masa: `0.055 M<sub>&#8853;</sub>`, 
                    Okres_orbitalny: "88 dni", 
                    Średnia_odległość: `${toMlnKm(0.387)} mln km`, 
                    Czas_podróży_światła: "3 min 17 sek", /* DODANO */
                    Ciekawostka: "Najmniejsza planeta Układu." 
                } 
            },
            { 
                name: "Wenus", size: 1.5, distance: 30, orbitPeriod: 225, dayLength: 243.0, epochOffsetAngle: 4.8, 
                color: 0xFFEBCD,
                mapUrl: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets@master/images/venusmap.jpg', 
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/c/c7/PIA23791-Venus-RealAndEnhancedContrastViews-20200608_%28cropped%29.jpg', 
                details: { 
                    Typ: "Planeta skalista", 
                    Masa: `0.815 M<sub>&#8853;</sub>`, 
                    Okres_orbitalny: "225 dni", 
                    Średnia_odległość: `${toMlnKm(0.723)} mln km`, 
                    Czas_podróży_światła: "6 min 0 sek", /* DODANO */
                    Ciekawostka: `Najgorętsza planeta (471 &deg;C).` 
                } 
            },
            { 
                name: "Ziemia", size: 1.8, distance: 40, orbitPeriod: 365.25, dayLength: 1.0, epochOffsetAngle: 0, 
                mapUrl: 'https://upload.wikimedia.org/wikipedia/commons/c/cb/The_Blue_Marble_%28remastered%29.jpg',
                color: 0x0077ff, 
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/9/97/The_Earth_seen_from_Apollo_17.jpg', 
                details: { 
                    Typ: "Planeta skalista", 
                    Masa: `1 M<sub>&#8853;</sub>`, 
                    Okres_orbitalny: "365 dni", 
                    Średnia_odległość: `${toMlnKm(1.000)} mln km`, 
                    Czas_podróży_światła: "8 min 20 sek", /* DODANO */
                    Ciekawostka: "Jedyna planeta z życiem." 
                } 
            },
            { 
                name: "Mars", size: 1.2, distance: 55, orbitPeriod: 687, dayLength: 1.03, epochOffsetAngle: 5.5, 
                color: 0xCC5500,
                mapUrl: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets@master/images/marsmap.jpg', 
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/0/02/OSIRIS_Mars_true_color.jpg', 
                details: { 
                    Typ: "Planeta skalista", 
                    Masa: `0.107 M<sub>&#8853;</sub>`, 
                    Okres_orbitalny: "687 dni", 
                    Średnia_odległość: `${toMlnKm(1.524)} mln km`, 
                    Czas_podróży_światła: "12 min 40 sek", /* DODANO */
                    Ciekawostka: "Nazywany 'Czerwoną Planetą'." 
                } 
            },
            { 
                name: "Jowisz", size: 6, distance: 90, orbitPeriod: 4333, dayLength: 0.41, epochOffsetAngle: 1.2, 
                color: 0xa07848,
                mapUrl: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets@master/images/jupitermap.jpg', 
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/0/0d/Jupiter_and_its_shrunken_Great_Red_Spot_%28cropped%29.jpg', 
                details: { 
                    Typ: "Gazowy olbrzym", 
                    Masa: `318 M<sub>&#8853;</sub>`, 
                    Okres_orbitalny: "11.86 lat", 
                    Średnia_odległość: `${toMlnKm(5.204)} mln km`, 
                    Czas_podróży_światła: "43 min 0 sek", /* DODANO */
                    Ciekawostka: "Największa planeta Układu." 
                } 
            },
            { 
                name: "Saturn", size: 5, distance: 120, orbitPeriod: 10759, dayLength: 0.44, epochOffsetAngle: 3.8, hasRings: true, 
                color: 0xE5D88B,
                mapUrl: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets@master/images/saturnmap.jpg', 
                ringMapUrl: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets@master/images/saturnringcolor.jpg', 
                ringAlphaMapUrl: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets@master/images/saturnringalpha.png', 
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/c/c1/Saturn_-_April_25_2016_%2837612580000%29.png', 
                details: { 
                    Typ: "Gazowy olbrzym", 
                    Masa: `95 M<sub>&#8853;</sub>`, 
                    Okres_orbitalny: "29.4 lat", 
                    Średnia_odległość: `${toMlnKm(9.582)} mln km`, 
                    Czas_podróży_światła: "1 godz. 19 min", /* DODANO */
                    Ciekawostka: "Posiada spektakularne pierścienie." 
                } 
            },
            { 
                name: "Uran", size: 3, distance: 150, orbitPeriod: 30687, dayLength: 0.72, epochOffsetAngle: 1.8, 
                color: 0xAFEEEE,
                mapUrl: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets@master/images/uranusmap.jpg', 
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/3/3d/Uranus2.jpg', 
                details: { 
                    Typ: "Lodowy olbrzym", 
                    Masa: `14.5 M<sub>&#8853;</sub>`, 
                    Okres_orbitalny: "84 lata", 
                    Średnia_odległość: `${toMlnKm(19.229)} mln km`, 
                    Czas_podróży_światła: "2 godz. 40 min", /* DODANO */
                    Ciekawostka: "Obraca się 'na boku'." 
                } 
            },
            { 
                name: "Neptun", size: 3, distance: 180, orbitPeriod: 60190, dayLength: 0.67, epochOffsetAngle: 0.5, 
                color: 0x00008B,
                mapUrl: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets@master/images/neptunemap.jpg', 
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/6/61/Neptune_Voyager2_color_calibrated%2C_brightened.png', 
                details: { 
                    Typ: "Lodowy olbrzym", 
                    Masa: `17 M<sub>&#8853;</sub>`, 
                    Okres_orbitalny: "165 lat", 
                    Średnia_odległość: `${toMlnKm(30.104)} mln km`, 
                    Czas_podróży_światła: "4 godz. 10 min", /* DODANO */
                    Ciekawostka: "Najbardziej oddalona planeta." 
                } 
            }
        ];

        // --- FUNKCJE UTILS ---
        function getDayDifference(date1, date2) {
            const msPerDay = 1000 * 60 * 60 * 24;
            // W tej symulacji używamy simulationDays jako różnicy w dniach.
            // Będziemy teraz używać pełnej daty, aby uwzględnić godzinę.
            return (date2.getTime() - date1.getTime()) / msPerDay;
        }

        window.setPlanetsToCurrentPositions = function() {
            const today = new Date();
            // Zmieniamy simulationDays na liczbę dni I CZĘŚCI DNIA
            simulationDays = getDayDifference(EPOCH_DATE, today);
            
            scene.children.forEach(object => {
                if (object.userData.orbitalRotationSpeed) {
                    const data = object.userData;
                    // Używamy simulationDays, które teraz zawiera ułamkową część dnia
                    const totalAngleShift = data.orbitalRotationSpeed * simulationDays;
                    data.currentAngle = (data.epochOffsetAngle + totalAngleShift) % (2 * Math.PI);
                    object.position.x = data.distance * Math.cos(data.currentAngle);
                    object.position.z = data.distance * Math.sin(data.currentAngle);
                }
            });
            setSpeedMultiplier(1);
        }

        window.setSpeedMultiplier = function(multiplier) {
            speedMultiplier = multiplier;
            document.querySelectorAll('#controls-panel button[id^="speed-x"]').forEach(btn => {
                btn.classList.replace('bg-blue-600', 'bg-gray-600');
            });
            document.getElementById(`speed-x${multiplier}`).classList.replace('bg-gray-600', 'bg-blue-600');
        }

        // Zaktualizowana funkcja do wyświetlania daty I GODZINY
        function updateDateTime() {
            const currentDate = new Date(EPOCH_DATE.getTime() + simulationDays * 24 * 60 * 60 * 1000);
            
            // Formatowanie daty: Dzień, miesiąc, rok
            const formattedDate = currentDate.toLocaleDateString('pl-PL', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // Formatowanie czasu: HH:MM:SS
            const formattedTime = currentDate.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            document.getElementById('current-date-time').innerHTML = 
                `<span class="text-sm block">${formattedDate}</span>
                 <span class="text-xl font-bold block">${formattedTime}</span>
                 <span class="text-xs block opacity-75">(Prędkość: x${speedMultiplier})</span>`;
        }

        window.closeModal = function() {
            document.getElementById('planet-modal').classList.add('hidden');
        }

        // --- DETEKCJA URZĄDZENIA I ORIENTACJA ---
        function detectDeviceAndShowInfo() {
            // Sprawdzenie czy urządzenie obsługuje dotyk
            const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            
            if (isTouchDevice) {
                document.getElementById('mobile-instructions').classList.remove('hidden');
            } else {
                document.getElementById('desktop-instructions').classList.remove('hidden');
            }
            
            // Uruchomienie obsługi orientacji
            handleOrientationChange();
        }

        function handleOrientationChange() {
            const controlsPanel = document.getElementById('controls-panel');
            // Szerokość breakpointa dla małych ekranów (np. 640px)
            const isMobileView = window.innerWidth < 640; 
            // Sprawdzenie, czy jesteśmy na urządzeniu mobilnym i czy jest to orientacja pozioma
            const isLandscapeMobile = isMobileView && (window.innerWidth > window.innerHeight);

            // Usunięcie starych klas układu
            controlsPanel.classList.remove('flex-col', 'flex-row', 'space-y-2', 'space-x-3', 'space-x-0');
            
            if (isLandscapeMobile || !isMobileView) {
                // Układ poziomy:
                // - Domyślnie na desktopie/tablecie (gdy isMobileView jest false)
                // - Na telefonie w orientacji poziomej (gdy isLandscapeMobile jest true)
                controlsPanel.classList.add('flex-row', 'space-x-3', 'p-3');
            } else {
                // Układ pionowy:
                // - Na telefonie w orientacji pionowej
                controlsPanel.classList.add('flex-col', 'space-y-2', 'p-2');
            }
        }

        // --- THREE.JS SETUP ---
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000); 

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 40, 150); 

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio); // Lepsza jakość na ekranach Retina
            container.appendChild(renderer.domElement);

            // Włączenie OrbitControls - to klucz do interakcji dotykowej (zoom, obrót)
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; 
            controls.dampingFactor = 0.05;
            controls.minDistance = 15; 
            controls.maxDistance = 500;
            controls.enablePan = false; // Zapobiega "gubieniu" słońca przy przesuwaniu

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Oświetlenie
            scene.add(new THREE.AmbientLight(0x404040, 0.7));
            const sunLight = new THREE.PointLight(0xffffff, 2, 500);
            scene.add(sunLight);

            createStars();
            createSun();
            planetData.forEach(createPlanet);
            setPlanetsToCurrentPositions();
            
            // Wywołanie detekcji instrukcji i obsługi orientacji
            detectDeviceAndShowInfo();

            // Event listenery
            window.addEventListener('resize', onWindowResize, false);
            
            // INTELIGENTNA OBSŁUGA KLIKNIĘCIA DLA DOTYKU I MYSZY
            let downTime = 0;
            let downPos = {x:0, y:0};

            renderer.domElement.addEventListener('pointerdown', (e) => {
                downTime = Date.now();
                downPos.x = e.clientX;
                downPos.y = e.clientY;
            });

            renderer.domElement.addEventListener('pointerup', (e) => {
                const timeDiff = Date.now() - downTime;
                const distDiff = Math.hypot(e.clientX - downPos.x, e.clientY - downPos.y);

                // Jeśli kliknięcie było krótkie (<300ms) i bez przesunięcia (<5px) -> to jest kliknięcie
                if (timeDiff < 300 && distDiff < 5) {
                    onCanvasClick(e);
                }
            });
        }

        function createStars() {
            const geo = new THREE.BufferGeometry();
            const verts = [];
            for (let i = 0; i < 5000; i++) verts.push((Math.random()-0.5)*2000, (Math.random()-0.5)*2000, (Math.random()-0.5)*2000);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));
            scene.add(new THREE.Points(geo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.7 })));
        }

        function createSun() {
            const geo = new THREE.SphereGeometry(10, 32, 32);
            const mat = new THREE.MeshBasicMaterial({ color: 0xFFD700 });
            
            textureLoader.load('https://upload.wikimedia.org/wikipedia/commons/7/73/Solar_Orbiter%E2%80%99s_widest_high-res_view_of_the_Sun_ESA508430.jpg',
                (tex) => { mat.map = tex; mat.needsUpdate = true; });

            const sun = new THREE.Mesh(geo, mat);
            sun.name = "Słońce";
            sun.userData.details = { 
                Typ: "Gwiazda", 
                Temperatura_powierzchni: `ok. 5500 &deg;C`, 
                Wiek: "ok. 4.6 mld lat", 
                Czas_podróży_światła: "0 sek", /* DLA SŁOŃCA */
                Ciekawostka: "99.8% masy układu." 
            };
            sun.userData.imageUrl = 'https://upload.wikimedia.org/wikipedia/commons/7/73/Solar_Orbiter%E2%80%99s_widest_high-res_view_of_the_Sun_ESA508430.jpg';
            scene.add(sun);
            addLabel(sun, "Słońce");
        }

        function createPlanet(data) {
            const geo = new THREE.SphereGeometry(data.size, 32, 32);
            const mat = new THREE.MeshLambertMaterial({ color: data.color });

            if (data.mapUrl) {
                textureLoader.load(data.mapUrl, (tex) => { mat.map = tex; mat.needsUpdate = true; }, undefined, (err) => console.warn("Błąd tekstury", data.name));
            }

            const mesh = new THREE.Mesh(geo, mat);
            mesh.name = data.name;
            mesh.position.x = data.distance; 

            mesh.userData = {
                ...data,
                currentAngle: data.epochOffsetAngle,
                orbitalRotationSpeed: (2 * Math.PI) / data.orbitPeriod,
                labelElement: addLabel(mesh, data.name)
            };
            planets.push(mesh);
            scene.add(mesh);

            // Orbita
            const curve = new THREE.EllipseCurve(0, 0, data.distance, data.distance, 0, 2*Math.PI, false, 0);
            const orbitGeo = new THREE.BufferGeometry().setFromPoints(curve.getPoints(128)).rotateX(Math.PI/2);
            scene.add(new THREE.Line(orbitGeo, new THREE.LineBasicMaterial({ color: 0x444444, transparent: true, opacity: 0.4 })));

            // Pierścienie
            if (data.hasRings && data.ringMapUrl) {
                const ringGeo = new THREE.RingGeometry(data.size*1.4, data.size*2.5, 64);
                const pos = ringGeo.attributes.position;
                const v3 = new THREE.Vector3();
                for (let i = 0; i < pos.count; i++){
                    v3.fromBufferAttribute(pos, i);
                    ringGeo.attributes.uv.setXY(i, v3.length() < (data.size*1.4+data.size*2.5)/2 ? 0 : 1, 1);
                }
                
                const ringMat = new THREE.MeshBasicMaterial({ side: THREE.DoubleSide, transparent: true, opacity: 0.8, color: 0xAAAAAA });
                textureLoader.load(data.ringMapUrl, (t) => { ringMat.map = t; ringMat.needsUpdate = true; });
                textureLoader.load(data.ringAlphaMapUrl, (t) => { ringMat.alphaMap = t; ringMat.needsUpdate = true; });

                const ring = new THREE.Mesh(ringGeo, ringMat);
                ring.rotation.x = Math.PI / 2;
                ring.rotation.y = -Math.PI / 8;
                mesh.add(ring);
            }
        }

        function addLabel(obj, text) {
            const div = document.createElement('div');
            div.className = 'planet-label';
            div.textContent = text;
            document.body.appendChild(div);
            return div;
        }

        function updateLabels() {
            planets.forEach(obj => {
                if(!obj.userData.labelElement) return;
                const v = new THREE.Vector3();
                obj.getWorldPosition(v);
                v.project(camera);
                
                // Ukryj jeśli za kamerą lub za daleko
                if(v.z > 1 || obj.position.distanceTo(camera.position) > 300) {
                    obj.userData.labelElement.style.display = 'none';
                    return;
                }

                const x = (v.x * .5 + .5) * container.clientWidth;
                const y = (v.y * -.5 + .5) * container.clientHeight;
                
                const el = obj.userData.labelElement;
                el.style.display = 'block';
                el.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
                el.style.left = '0'; // Reset pozycji, używamy transform dla wydajności
                el.style.top = '0';
            });
            // Update Słońca label
            const sun = scene.getObjectByName('Słońce');
            /* (podobna logika dla Słońca - uproszczone dla czytelności) */
        }

        function onCanvasClick(event) {
            // Ignoruj jeśli modal otwarty
            if (!document.getElementById('planet-modal').classList.contains('hidden')) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children);
            
            // Szukamy tylko Meshy które mają userData.details
            const hit = intersects.find(i => i.object.userData.details);
            if (hit) displayPlanetInfo(hit.object);
        }

        function displayPlanetInfo(mesh) {
            const modal = document.getElementById('planet-modal');
            document.getElementById('modal-planet-name').textContent = mesh.name;
            const imgContainer = document.getElementById('modal-image-container');
            imgContainer.innerHTML = '';
            
            if(mesh.userData.imageUrl) {
                imgContainer.innerHTML = `<img src="${mesh.userData.imageUrl}" class="modal-img" alt="${mesh.name}" onerror="this.src='https://placehold.co/400x200?text=Brak+foto'">`;
            }

            let html = '';
            // Używamy Object.entries, aby przeiterować przez klucze w kolejności zdefiniowanej w planetData
            for (const [key, val] of Object.entries(mesh.userData.details)) {
                html += `<div class="flex justify-between border-b border-gray-700 pb-1">
                            <span class="font-medium text-gray-400">${key.replace(/_/g, ' ')}:</span>
                            <span class="text-white font-semibold text-right">${val}</span>
                         </div>`;
            }
            document.getElementById('modal-planet-details').innerHTML = html;
            modal.classList.remove('hidden');
        }

        let lastTime = 0;
        let lastDateTimeUpdate = 0;

        function animate(time) {
            requestAnimationFrame(animate);
            const dt = time - lastTime;
            lastTime = time;

            // Używamy dt (różnicy czasu) dla płynniejszego ruchu
            const elapsedSeconds = dt / 1000;
            // Skalujemy przyrost dnia do prędkości animacji
            const elapsedDays = elapsedSeconds * speedMultiplier * timeScale / 0.00005; 
            simulationDays += elapsedDays;

            planets.forEach(p => {
                const d = p.userData;
                // Obliczamy przyrost kąta na podstawie nowej, płynniejszej wartości elapsedDays
                d.currentAngle += d.orbitalRotationSpeed * elapsedDays;
                p.position.x = d.distance * Math.cos(d.currentAngle);
                p.position.z = d.distance * Math.sin(d.currentAngle);
                p.rotation.y += 0.01;
            });

            controls.update();
            updateLabels();

            if (time - lastDateTimeUpdate > 100) { // Aktualizacja UI co 100ms
                updateDateTime();
                lastDateTimeUpdate = time;
            }

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            // Uruchomienie obsługi orientacji przy zmianie rozmiaru okna
            handleOrientationChange();
        }

        window.onload = function() {
            if (typeof THREE !== 'undefined') init(), animate(0);
        };
    </script>
</body>
</html>



